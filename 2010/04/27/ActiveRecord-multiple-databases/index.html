<!DOCTYPE html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="google-site-verification" content="GOOGLEWEBMASTER">
	<link href="http://your.site.comatom.xml" rel="alternate" title="Hammer | ruby component based state-full web framework" type="application/atom+xml">
	<link rel="stylesheet" media="all" href="/css/master.css">
	<link rel="stylesheet" media="all" href="/css/mediaqueries.css">
	<script src="/js/modernizr.js"></script>
	
		<title>ActiveRecord: multiple databases | Hammer | ruby component based state-full web framework</title>
		<meta name="description" content="I and a colleague of mine needed access to multiple databases with same model a few weeks back. ActiveRecord sets database on class level, so...">
	
  <link rel="shortcut icon" href="/img/hammer.png">
</head>

<body class="post">
	<div id="page">
				<header id="head">
		<div class="head_inner">
			<ul>
				<li class="logo"><a href="/">Hammer</a></li>
				<li class="tagline">ruby component based state-full web framework</li>
			</ul>
		</div>
		</header><!-- id="head" -->

		<div id="main" role="main">
			<div class="main_inner">
				<header class="hd_article">
					<h1>ActiveRecord: multiple databases</h1>
						<div class="meta">
							<date title="2010-04-27T00:00:00+02:00">
								<span class="published">Published: </span>
								<span class="day">27</span>
								<span class="month"><abbr>Apr</abbr></span>
								<span class="year">2010</span>
							</date>
						</div>
				</header>
				<article class="the_article">
				<div class="article_inner">
					<div class="content">
            <p>I and a colleague of mine needed access to multiple databases with same model a few weeks back. ActiveRecord sets database on class level, so we needed to generate classes for each database dynamically. Here is the solution.</p>
<div class='highlight'><pre><code class='ruby'><span class='k'>class</span> <span class='nc'>Remote</span> <span class='o'>&lt;</span> <span class='no'>ActiveRecord</span><span class='o'>::</span><span class='no'>Base</span>
  <span class='vi'>@abstract_class</span> <span class='o'>=</span> <span class='kp'>true</span>

  <span class='k'>def</span> <span class='nc'>self</span><span class='o'>.</span><span class='nf'>db_context</span><span class='p'>(</span><span class='n'>db_name</span><span class='p'>,</span> <span class='o'>&amp;</span><span class='n'>block</span><span class='p'>)</span>
    <span class='k'>if</span> <span class='nb'>block_given?</span>
      <span class='n'>block</span><span class='o'>.</span><span class='n'>call</span> <span class='n'>remote_class</span><span class='p'>(</span><span class='n'>db_name</span><span class='p'>)</span>
    <span class='k'>else</span>
      <span class='k'>return</span> <span class='n'>remote_class</span><span class='p'>(</span><span class='n'>db_name</span><span class='p'>)</span>
    <span class='k'>end</span>
  <span class='k'>end</span>

  <span class='kp'>private</span>

  <span class='k'>def</span> <span class='nc'>self</span><span class='o'>.</span><span class='nf'>remote_classes</span>
    <span class='vi'>@remote_classes</span> <span class='o'>||=</span> <span class='p'>{}</span>
  <span class='k'>end</span>

  <span class='c1'># returns proper class from cache or creates new one</span>
  <span class='k'>def</span> <span class='nc'>self</span><span class='o'>.</span><span class='nf'>remote_class</span><span class='p'>(</span><span class='n'>db_name</span><span class='p'>)</span>
    <span class='n'>remote_classes</span><span class='o'>[</span><span class='n'>db_name</span><span class='o'>]</span> <span class='o'>||=</span> <span class='k'>begin</span>
      <span class='c1'># creates dynamically descendant Class of self</span>
      <span class='n'>remote_class</span> <span class='o'>=</span> <span class='no'>Class</span><span class='o'>.</span><span class='n'>new</span><span class='p'>(</span><span class='nb'>self</span><span class='p'>)</span>
      <span class='n'>remote_class</span><span class='o'>.</span><span class='n'>class_eval</span> <span class='p'>{</span> <span class='n'>establish_connection</span> <span class='n'>db_hash</span><span class='p'>(</span><span class='n'>db_name</span><span class='p'>)</span> <span class='p'>}</span>
      <span class='n'>remote_class</span>
    <span class='k'>end</span>
  <span class='k'>end</span>

  <span class='k'>def</span> <span class='nc'>self</span><span class='o'>.</span><span class='nf'>db_hash</span><span class='p'>(</span><span class='n'>db_name</span><span class='p'>)</span>
    <span class='c1'># returns db hash for connection to db_name</span>
  <span class='k'>end</span>

<span class='k'>end</span>

<span class='k'>class</span> <span class='nc'>RemoteSomething</span> <span class='o'>&lt;</span> <span class='no'>Remote</span>
  <span class='vi'>@abstract_class</span> <span class='o'>=</span> <span class='kp'>true</span>
  <span class='n'>set_table_name</span> <span class='s2'>&quot;somethings&quot;</span>

  <span class='c1'># actual model definition</span>
  <span class='c1'># validations, callbacks etc for Something</span>
<span class='k'>end</span>

<span class='c1'>## usage ##</span>

<span class='c1'># finds all objects in DB db_name</span>
<span class='no'>RemoteSomething</span><span class='o'>.</span><span class='n'>db_context</span><span class='p'>(</span><span class='n'>db_name</span><span class='p'>)</span><span class='o'>.</span><span class='n'>all</span>
<span class='c1'># or with block</span>
<span class='no'>RemoteSomething</span><span class='o'>.</span><span class='n'>db_context</span><span class='p'>(</span><span class='n'>db_name</span><span class='p'>)</span> <span class='k'>do</span> <span class='o'>|</span><span class='n'>klass</span><span class='o'>|</span>
  <span class='n'>klass</span><span class='o'>.</span><span class='n'>all</span>
  <span class='n'>klass</span><span class='o'>.</span><span class='n'>first</span>
<span class='k'>end</span>
</code></pre>
</div>
<p>This is probably bad idea if number of remote databases is not limited or they change a lot, but this wasn&#8217;t our case. Source code is at <a href='http://gist.github.com/380518'>http://gist.github.com/380518</a>.</p>
          </div>
          <div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'ruby-hammer'; // required: replace example with your forum shortname

  // The following are highly recommended additional parameters. Remove the slashes in front to use.
  var disqus_identifier = '';
  // var disqus_url = 'http://example.com/permalink-to-page.html';

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

				</div>          
				</article>        
			</div>
		</div><!-- id="main" -->
		<nav class="pagenation">
		<ul>
		
		
			<li class="next right"><a rel="next" href="/2011/05/10/HammerBuilder-introduction/" class="btn" title="View HammerBuilder Introduction">Next</a></li>
		
		</ul>
		</nav>
		<footer id="foot">
<div class="foot_inner">
	<div class="hasGrid">
		<div class="left alpha grid-6"><h4></h4>

<p>
Powerd by <a href="https://github.com/mojombo/jekyll">jekyll</a>,
<a href="http://minimum.layouts-the.me/">_minimum</a>,
<a href="http://disqus.com">Disqus</a>

</p>
</div>
		<div class="right omega grid-6"><h4>TODO</h4>
<p>author, links, pledge</p></div>
	</div>
</div>
</footer><!-- id="foot" -->

	</div><!-- id="page" -->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.js"></script>
<!-- You may want to stats with your blog if not you should erase this file and remove inculude link from 
You don't need to edit this file, you can set your ID at _config.yml -->
<script>
	var _gaq = [['_setAccount', 'UA-XXXXX-X'], ['_trackPageview']];
	(function(d, t) {
		var g = d.createElement(t),
        s = d.getElementsByTagName(t)[0];
		g.async = true;
		g.src = ('https:' == location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		s.parentNode.insertBefore(g, s);
	})(document, 'script');
</script>


</body>
</html>
